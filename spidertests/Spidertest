pipeline {

    agent any

    stages {
       stage('SOAP testing') {
            steps {
                withCredentials([certificate(credentialsId: 'TSTNMT2321000156-B02', keystoreVariable: 'CERTKEY', passwordVariable: 'CERTKEYPWD')]) {
                    sh """
                        openssl pkcs12 -nodes -out CRT.pem -passin pass:$CERTKEYPWD -in $CERTKEY
                        echo "zeep junit-xml" > requirements.txt
                        docker run python:3 \
                               -v "$WORKSPACE":/usr/src/spider \
                               -w /usr/src/spider \
                               -e CERTFILE=/usr/src/spider/CRT.pem \
                               -e PLATFORM=$PLATFORM \
                               -e ENVIRONMENT=$ENVIRONMENT \
                               -e CONSUMERHSAID=$CONSUMERHSAID \
                               -e SERVICEURL=$SERVICEURL \
                               -e WSDLURL=$WSDLURL \
                               python:3 spidertests/spidertest.py
                    """
                }
            }
        }
    }

    post {
        always {
            // Archive results
            junit healthScaleFactor: 100.0, testResults: 'spideroutput.xml'
        }
    }
}
